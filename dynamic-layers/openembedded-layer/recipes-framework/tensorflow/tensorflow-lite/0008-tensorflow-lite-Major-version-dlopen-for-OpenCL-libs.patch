From 2122001bc7e3106bb019feb5eef2daaf97bb441c Mon Sep 17 00:00:00 2001
From: Tushar Darote <quic_tdarote@quicinc.com>
Date: Thu, 9 Oct 2025 22:42:17 +0200
Subject: [PATCH 8/8] tensorflow-lite: Major version dlopen for OpenCL libs

Upstream-Status: Inappropriate [OE specific]
Change-Id: I8987e4ce0206257b08e9720fee433770d7fefec6
Signed-off-by: Tushar Darote <quic_tdarote@quicinc.com>
---
 tensorflow/lite/CMakeLists.txt                     | 14 ++++++++++++++
 tensorflow/lite/delegates/gpu/cl/opencl_wrapper.cc |  4 ++++
 2 files changed, 18 insertions(+)

diff --git a/tensorflow/lite/CMakeLists.txt b/tensorflow/lite/CMakeLists.txt
index 3198ec61e0b..591dca9efaa 100644
--- a/tensorflow/lite/CMakeLists.txt
+++ b/tensorflow/lite/CMakeLists.txt
@@ -745,6 +745,20 @@ if (NOT BUILD_SHARED_LIBS)
   list(APPEND TFLITE_TARGET_PUBLIC_OPTIONS "-DTFL_STATIC_LIBRARY_BUILD")
 endif()
 
+find_package(PkgConfig)
+pkg_check_modules(OPENCL opencl)
+
+if(OPENCL_FOUND)
+  string(REGEX MATCH "^[0-9]+" OPENCL_VERSION_MAJOR ${OPENCL_VERSION})
+  set(CL_LIB_NAME "libOpenCL.so.${OPENCL_VERSION_MAJOR}")
+else()
+  set(CL_LIB_NAME "libOpenCL.so")
+endif()
+
+target_compile_definitions(tensorflow-lite
+  PRIVATE CL_LIB_NAME=\"${CL_LIB_NAME}\"
+)
+
 target_compile_options(tensorflow-lite
   PUBLIC ${TFLITE_TARGET_PUBLIC_OPTIONS}
   PRIVATE ${TFLITE_TARGET_PRIVATE_OPTIONS}
diff --git a/tensorflow/lite/delegates/gpu/cl/opencl_wrapper.cc b/tensorflow/lite/delegates/gpu/cl/opencl_wrapper.cc
index 8ac71c9de67..3bb83899d96 100644
--- a/tensorflow/lite/delegates/gpu/cl/opencl_wrapper.cc
+++ b/tensorflow/lite/delegates/gpu/cl/opencl_wrapper.cc
@@ -119,7 +119,11 @@ absl::Status LoadOpenCLOnce() {
   static const char* kClLibName =
       "/System/Library/Frameworks/OpenCL.framework/OpenCL";
 #else
+#ifndef CL_LIB_NAME
   static const char* kClLibName = "libOpenCL.so";
+#else
+  static const char* kClLibName = CL_LIB_NAME;
+#endif
 #endif
 #ifdef __ANDROID__
   libopencl = AndroidDlopenSphalLibrary(kClLibName, RTLD_NOW | RTLD_LOCAL);
-- 
2.34.1

