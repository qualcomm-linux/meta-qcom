From 93646fb59c15da579acd91a3bfd2f4f4e21b9025 Mon Sep 17 00:00:00 2001
From: Tushar Darote <tdarote@qti.qualcomm.com>
Date: Wed, 31 Dec 2025 12:24:13 +0530
Subject: [PATCH 1/8] fix(gpu): adjust work-group size and remove
 Adreno-specific alignment

- Updated `GetPossibleWorkGroups()` in `work_group_picking.cc`:
  Use `std::min(kernel_info.max_work_group_size, gpu_info.GetMaxWorkGroupSizeForX())`
  to ensure work-group size respects GPU X-dimension limits.

- Removed Adreno-specific pitch alignment logic in `inference_context.cc`:
  Eliminated conditional division by `bytes_per_pixel` for width alignment
  to simplify and standardize buffer size calculation.

Impact:
- Improves compatibility across GPUs.
- Prevents oversized work-groups and incorrect buffer alignment on Adreno devices.

Upstream-Status: Pending

Change-Id: I3de58b529b95255e68ced7a9915a6dc49c7fd9e5
Signed-off-by: Tushar Darote <tdarote@qti.qualcomm.com>
---
 tensorflow/lite/delegates/gpu/cl/inference_context.cc      | 7 -------
 .../lite/delegates/gpu/common/task/work_group_picking.cc   | 2 +-
 2 files changed, 1 insertion(+), 8 deletions(-)

diff --git a/tensorflow/lite/delegates/gpu/cl/inference_context.cc b/tensorflow/lite/delegates/gpu/cl/inference_context.cc
index fa28a4c6944..795dd3374b8 100644
--- a/tensorflow/lite/delegates/gpu/cl/inference_context.cc
+++ b/tensorflow/lite/delegates/gpu/cl/inference_context.cc
@@ -179,9 +179,6 @@ absl::Status GetBufferAssignment(
       const size_t width = shape.b * shape.w;
       const size_t height = shape.h * DivideRoundUp(shape.c, 4);
       size_t width_pixel_alignment = gpu_info.opencl_info.image_pitch_alignment;
-      if (gpu_info.IsAdreno() && width_pixel_alignment % bytes_per_pixel == 0) {
-        width_pixel_alignment /= bytes_per_pixel;
-      }
       const size_t width_aligned = AlignByN(width, width_pixel_alignment);
       buffer_size = width_aligned * bytes_per_pixel * height;
     } else {
@@ -659,10 +656,6 @@ absl::Status InferenceContext::AllocateBufferBasedTensors(
                  : tensor_desc.GetBHWCShape().c);
         size_t width_pixel_alignment =
             gpu_info.opencl_info.image_pitch_alignment;
-        if (gpu_info.IsAdreno() &&
-            width_pixel_alignment % bytes_per_pixel == 0) {
-          width_pixel_alignment /= bytes_per_pixel;
-        }
         RETURN_IF_ERROR(CreateTensorSharedImage2DBuffer(
             *context, shared_buffers_[buffer_index].GetMemoryPtr(), tensor_desc,
             width_pixel_alignment, &shared_buffer_tensors_[tensor_index]));
diff --git a/tensorflow/lite/delegates/gpu/common/task/work_group_picking.cc b/tensorflow/lite/delegates/gpu/common/task/work_group_picking.cc
index 0469891179e..a4946b37fcd 100644
--- a/tensorflow/lite/delegates/gpu/common/task/work_group_picking.cc
+++ b/tensorflow/lite/delegates/gpu/common/task/work_group_picking.cc
@@ -278,7 +278,7 @@ void GetPossibleWorkGroups(TuningType tuning_type, const GpuInfo& gpu_info,
   switch (tuning_type) {
     case TuningType::kFast:
       work_groups->push_back(
-          GetWorkGroup(grid, kernel_info.max_work_group_size));
+          GetWorkGroup(grid, std::min(kernel_info.max_work_group_size, gpu_info.GetMaxWorkGroupSizeForX())));
       return;
     case TuningType::kExhaustive: {
       GetWorkGroupsAlignedToGrid(gpu_info, kernel_info, grid, work_groups);
-- 
2.34.1

