From ad64b5838a68fbe588995b60fcba4a21d18da807 Mon Sep 17 00:00:00 2001
From: Tushar Darote <tdarote@qti.qualcomm.com>
Date: Fri, 2 Jan 2026 11:23:15 +0530
Subject: [PATCH 7/8] feat(tflite): Improve shared library linking and build
 configuration

This change enhances the CMake build system to better support shared library creation by:

1. **Shared Library Linking Fixes**: Added explicit linker options to force resolution of delegate create/delete functions from static to shared libraries across different platforms (Windows, macOS, Linux). This ensures proper symbol resolution when building shared libraries with delegates enabled.

2. **Build System Optimizations**: Added `EXCLUDE_FROM_ALL` to multiple dependency subdirectories (cpuinfo, eigen, farmhash, fft2d, flatbuffers, gemmlowp, neon2sse, ruy) to reduce build overhead and avoid unnecessary compilation of unused dependencies.

3. **OpenCL Library Handling**: Simplified OpenCL library name handling in the wrapper by removing redundant conditional compilation and relying on the preprocessor-defined `CL_LIB_NAME` macro.

The changes improve build reliability and performance when creating shared TensorFlow Lite libraries with various delegates enabled.

Upstream-Status: Pending
Change-Id: Ifbad44ae9244395fd6647dc54e8c1d009af03868
Signed-off-by: Tushar Darote <tdarote@qti.qualcomm.com>
---
 tensorflow/lite/c/CMakeLists.txt              | 42 +++++++++++++++++++
 .../lite/delegates/gpu/cl/opencl_wrapper.cc   |  4 --
 .../lite/tools/cmake/modules/cpuinfo.cmake    |  1 +
 .../lite/tools/cmake/modules/eigen.cmake      |  2 +-
 .../lite/tools/cmake/modules/farmhash.cmake   |  1 +
 .../lite/tools/cmake/modules/fft2d.cmake      |  1 +
 .../tools/cmake/modules/flatbuffers.cmake     |  1 +
 .../lite/tools/cmake/modules/gemmlowp.cmake   |  1 +
 .../lite/tools/cmake/modules/neon2sse.cmake   |  1 +
 tensorflow/lite/tools/cmake/modules/ruy.cmake |  1 +
 10 files changed, 50 insertions(+), 5 deletions(-)

diff --git a/tensorflow/lite/c/CMakeLists.txt b/tensorflow/lite/c/CMakeLists.txt
index 931f4372c5f..9fcafb14495 100644
--- a/tensorflow/lite/c/CMakeLists.txt
+++ b/tensorflow/lite/c/CMakeLists.txt
@@ -80,10 +80,52 @@ if (TFLITE_C_BUILD_SHARED_LIBS)
   if (WIN32)
     target_compile_definitions(tensorflowlite_c PRIVATE TFL_COMPILE_LIBRARY)
     target_compile_definitions(tensorflow-lite PRIVATE TFL_COMPILE_LIBRARY)
+    # Force the linker to treat delegate create and delete as undefined
+    #   to pull them from static to shared library
+    if (TFLITE_ENABLE_XNNPACK)
+      target_link_options(tensorflowlite_c PRIVATE "/INCLUDE:TfLiteXNNPackDelegateCreate")
+      target_link_options(tensorflowlite_c PRIVATE "/INCLUDE:TfLiteXNNPackDelegateDelete")
+    endif()
+    if (TFLITE_ENABLE_EXTERNAL_DELEGATE)
+      target_link_options(tensorflowlite_c PRIVATE "/INCLUDE:TfLiteExternalDelegateCreate")
+      target_link_options(tensorflowlite_c PRIVATE "/INCLUDE:TfLiteExternalDelegateDelete")
+    endif()
+    if (CMAKE_SYSTEM_NAME MATCHES "Android" OR TFLITE_ENABLE_GPU)
+      target_link_options(tensorflowlite_c PRIVATE "/INCLUDE:TfLiteGpuDelegateV2Create")
+      target_link_options(tensorflowlite_c PRIVATE "/INCLUDE:TfLiteGpuDelegateV2Delete")
+    endif()
   elseif (APPLE)
     target_link_options(tensorflowlite_c PRIVATE "-Wl,-exported_symbols_list,${TFLITE_SOURCE_DIR}/c/exported_symbols.lds")
+    # Force the linker to treat delegate create and delete as undefined
+    #   to pull them from static to shared library
+    if (TFLITE_ENABLE_XNNPACK)
+      target_link_options(tensorflowlite_c PRIVATE "-Wl,-u,_TfLiteXNNPackDelegateCreate")
+      target_link_options(tensorflowlite_c PRIVATE "-Wl,-u,_TfLiteXNNPackDelegateDelete")
+    endif()
+    if (TFLITE_ENABLE_EXTERNAL_DELEGATE)
+      target_link_options(tensorflowlite_c PRIVATE "-Wl,-u,_TfLiteExternalDelegateCreate")
+      target_link_options(tensorflowlite_c PRIVATE "-Wl,-u,_TfLiteExternalDelegateDelete")
+    endif()
+    if (CMAKE_SYSTEM_NAME MATCHES "Android" OR TFLITE_ENABLE_GPU)
+      target_link_options(tensorflowlite_c PRIVATE "-Wl,-u,_TfLiteGpuDelegateV2Create")
+      target_link_options(tensorflowlite_c PRIVATE "-Wl,-u,_TfLiteGpuDelegateV2Delete")
+    endif()
   else ()
     target_link_options(tensorflowlite_c PRIVATE "-Wl,--version-script,${TFLITE_SOURCE_DIR}/c/version_script.lds")
+    # Force the linker to treat delegate create and delete as undefined
+    #   to pull them from static to shared library
+    if (TFLITE_ENABLE_XNNPACK)
+      target_link_options(tensorflowlite_c PRIVATE "-Wl,-u,TfLiteXNNPackDelegateCreate")
+      target_link_options(tensorflowlite_c PRIVATE "-Wl,-u,TfLiteXNNPackDelegateDelete")
+    endif()
+    if (TFLITE_ENABLE_EXTERNAL_DELEGATE)
+      target_link_options(tensorflowlite_c PRIVATE "-Wl,-u,TfLiteExternalDelegateCreate")
+      target_link_options(tensorflowlite_c PRIVATE "-Wl,-u,TfLiteExternalDelegateDelete")
+    endif()
+    if (CMAKE_SYSTEM_NAME MATCHES "Android" OR TFLITE_ENABLE_GPU)
+      target_link_options(tensorflowlite_c PRIVATE "-Wl,-u,TfLiteGpuDelegateV2Create")
+      target_link_options(tensorflowlite_c PRIVATE "-Wl,-u,TfLiteGpuDelegateV2Delete")
+    endif()
   endif()
 endif()
 
diff --git a/tensorflow/lite/delegates/gpu/cl/opencl_wrapper.cc b/tensorflow/lite/delegates/gpu/cl/opencl_wrapper.cc
index 49551fd372a..b8229ec1f96 100644
--- a/tensorflow/lite/delegates/gpu/cl/opencl_wrapper.cc
+++ b/tensorflow/lite/delegates/gpu/cl/opencl_wrapper.cc
@@ -118,13 +118,9 @@ absl::Status LoadOpenCLOnce() {
 #ifdef __APPLE__
   static const char* kClLibName =
       "/System/Library/Frameworks/OpenCL.framework/OpenCL";
-#else
-#ifndef CL_LIB_NAME
-  static const char* kClLibName = "libOpenCL.so";
 #else
   static const char* kClLibName = CL_LIB_NAME;
 #endif
-#endif
 #ifdef __ANDROID__
   libopencl = AndroidDlopenSphalLibrary(kClLibName, RTLD_NOW | RTLD_LOCAL);
   if (!libopencl) {
diff --git a/tensorflow/lite/tools/cmake/modules/cpuinfo.cmake b/tensorflow/lite/tools/cmake/modules/cpuinfo.cmake
index 5556bec6448..8d1124ff261 100644
--- a/tensorflow/lite/tools/cmake/modules/cpuinfo.cmake
+++ b/tensorflow/lite/tools/cmake/modules/cpuinfo.cmake
@@ -41,4 +41,5 @@ set(CPUINFO_BUILD_BENCHMARKS OFF CACHE BOOL "Disable cpuinfo micro-benchmarks")
 add_subdirectory(
   "${cpuinfo_SOURCE_DIR}"
   "${cpuinfo_BINARY_DIR}"
+  EXCLUDE_FROM_ALL
 )
diff --git a/tensorflow/lite/tools/cmake/modules/eigen.cmake b/tensorflow/lite/tools/cmake/modules/eigen.cmake
index cf73d72fb32..c2ffd3f3d78 100644
--- a/tensorflow/lite/tools/cmake/modules/eigen.cmake
+++ b/tensorflow/lite/tools/cmake/modules/eigen.cmake
@@ -99,4 +99,4 @@ set(EIGEN_TEST_SYCL OFF CACHE BOOL "Disable Sycl test")
 set(EIGEN_SYCL_TRISYCL OFF CACHE BOOL "Disable triSYCL test")
 # Make sure only MPL2.0 or more permissively licensed code is included.
 add_compile_definitions(EIGEN_MPL2_ONLY)
-add_subdirectory("${eigen_SOURCE_DIR}" "${eigen_BINARY_DIR}")
+add_subdirectory("${eigen_SOURCE_DIR}" "${eigen_BINARY_DIR}" EXCLUDE_FROM_ALL)
diff --git a/tensorflow/lite/tools/cmake/modules/farmhash.cmake b/tensorflow/lite/tools/cmake/modules/farmhash.cmake
index 9c8e039e6fe..7a5160fa7eb 100644
--- a/tensorflow/lite/tools/cmake/modules/farmhash.cmake
+++ b/tensorflow/lite/tools/cmake/modules/farmhash.cmake
@@ -44,4 +44,5 @@ set(FARMHASH_SOURCE_DIR "${farmhash_SOURCE_DIR}" CACHE PATH
 add_subdirectory(
   "${CMAKE_CURRENT_LIST_DIR}/farmhash"
   "${farmhash_BINARY_DIR}"
+  EXCLUDE_FROM_ALL
 )
diff --git a/tensorflow/lite/tools/cmake/modules/fft2d.cmake b/tensorflow/lite/tools/cmake/modules/fft2d.cmake
index b4169104fae..9d44a2c6865 100644
--- a/tensorflow/lite/tools/cmake/modules/fft2d.cmake
+++ b/tensorflow/lite/tools/cmake/modules/fft2d.cmake
@@ -37,4 +37,5 @@ set(FFT2D_SOURCE_DIR "${fft2d_SOURCE_DIR}" CACHE PATH "fft2d source")
 add_subdirectory(
   "${CMAKE_CURRENT_LIST_DIR}/fft2d"
   "${fft2d_BINARY_DIR}"
+  EXCLUDE_FROM_ALL
 )
diff --git a/tensorflow/lite/tools/cmake/modules/flatbuffers.cmake b/tensorflow/lite/tools/cmake/modules/flatbuffers.cmake
index 8febb1fbd1c..267031de68f 100644
--- a/tensorflow/lite/tools/cmake/modules/flatbuffers.cmake
+++ b/tensorflow/lite/tools/cmake/modules/flatbuffers.cmake
@@ -42,6 +42,7 @@ add_definitions(-DNOMINMAX=1)
 add_subdirectory(
   "${flatbuffers_SOURCE_DIR}"
   "${flatbuffers_BINARY_DIR}"
+  EXCLUDE_FROM_ALL
 )
 remove_definitions(-DNOMINMAX)
 
diff --git a/tensorflow/lite/tools/cmake/modules/gemmlowp.cmake b/tensorflow/lite/tools/cmake/modules/gemmlowp.cmake
index 76d9705475b..9c8e2c90c7c 100644
--- a/tensorflow/lite/tools/cmake/modules/gemmlowp.cmake
+++ b/tensorflow/lite/tools/cmake/modules/gemmlowp.cmake
@@ -48,6 +48,7 @@ set(GEMMLOWP_SOURCE_DIR "${gemmlowp_SOURCE_DIR}" CACHE PATH "Source directory")
 add_subdirectory(
   "${gemmlowp_SOURCE_DIR}/contrib"
   "${gemmlowp_BINARY_DIR}"
+  EXCLUDE_FROM_ALL
 )
 
 set(BUILD_TESTING ${BUILD_TESTING_TMP})
diff --git a/tensorflow/lite/tools/cmake/modules/neon2sse.cmake b/tensorflow/lite/tools/cmake/modules/neon2sse.cmake
index c2612e34bd2..77bcf1acba3 100644
--- a/tensorflow/lite/tools/cmake/modules/neon2sse.cmake
+++ b/tensorflow/lite/tools/cmake/modules/neon2sse.cmake
@@ -40,4 +40,5 @@ endif()
 add_subdirectory(
   "${neon2sse_SOURCE_DIR}"
   "${neon2sse_BINARY_DIR}"
+  EXCLUDE_FROM_ALL
 )
diff --git a/tensorflow/lite/tools/cmake/modules/ruy.cmake b/tensorflow/lite/tools/cmake/modules/ruy.cmake
index 1c5965f94f5..a6632d3247f 100644
--- a/tensorflow/lite/tools/cmake/modules/ruy.cmake
+++ b/tensorflow/lite/tools/cmake/modules/ruy.cmake
@@ -37,4 +37,5 @@ set(RUY_SOURCE_DIR "${ruy_SOURCE_DIR}" CACHE PATH "RUY source directory")
 add_subdirectory(
   "${ruy_SOURCE_DIR}"
   "${ruy_BINARY_DIR}"
+  EXCLUDE_FROM_ALL
 )
-- 
2.34.1

